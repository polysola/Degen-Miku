jQuery(document).ready(function () {
  // Initialize Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyD55ZnU_GX7L5varAuprnWugy_FDXM1FhQ",
    authDomain: "data-sui.firebaseapp.com",
    projectId: "data-sui",
    storageBucket: "data-sui.appspot.com",
    messagingSenderId: "15867478435",
    appId: "1:15867478435:web:9d2b205c67e828c8385a16",
    measurementId: "G-9HKQLMBCKN",
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Initialize score
  let score = 0;
  let saveTimeout = null;
  const defaultAvatar = "./images/site-300x300.png";

  // Add user profile HTML dynamically
  jQuery("body").append(`
    <div id="userProfile" style="position: fixed; top: 20px; right: 20px; display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.95); padding: 15px 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); backdrop-filter: blur(10px); z-index: 1000; transition: all 0.3s ease;">
      <img id="userAvatar" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid #FFD936;" src="${defaultAvatar}" alt="User Avatar">
      <div style="display: flex; flex-direction: column;">
        <span id="userName" style="font-weight: 600; font-size: 16px; color: #536942;">Please login by Telegram</span>
        <span id="userScore" style="color: #536942; font-size: 14px; font-weight: 500;">Score: 0</span>
      </div>
    </div>
  `);

  // Load score from Firebase with proper update
  async function loadScore() {
    try {
      console.log("Loading score from Firebase...");
      const doc = await db.collection("users").doc("useronweb").get();
      if (doc.exists) {
        score = doc.data().score || 0;
        console.log("Score loaded:", score);
        jQuery("#userScore").text(`Score: ${score}`);
      } else {
        console.log("No score found in Firebase");
        score = 0;
      }
    } catch (error) {
      console.error("Error loading score:", error);
    }
  }

  // Debounced save score to Firebase
  function debouncedSaveScore() {
    if (saveTimeout) {
      clearTimeout(saveTimeout);
    }
    saveTimeout = setTimeout(async () => {
      try {
        console.log("Saving score to Firebase:", score);
        await db.collection("users").doc("useronweb").set({
          score: score,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
        });
        console.log("Score saved successfully!");
      } catch (error) {
        console.error("Error saving score:", error);
      }
    }, 1000); // 1 second delay
  }

  // Update score display with animation
  function updateScore() {
    jQuery("#userScore").text(`Score: ${score}`);
    jQuery("#userProfile").css("transform", "scale(1.05)");
    setTimeout(() => {
      jQuery("#userProfile").css("transform", "scale(1)");
    }, 200);
  }

  // Handle click events
  jQuery("body").on(
    "click",
    ".bdt-element-link[data-id='a9ef003']",
    function (e) {
      e.preventDefault();
      console.log("Click detected! Current score:", score);
      score += 1;
      updateScore();
      debouncedSaveScore();
      createParticles(e.pageX, e.pageY);
      console.log("Score increased to:", score);
    }
  );

  // Initialize when page loads
  loadScore();
});
